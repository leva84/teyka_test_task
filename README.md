# Тестовое задание ТЕЙКА

## I. Основная информация

В рамках задания необходимо реализовать **расчет и подтверждение операции покупки клиента**.

### Описание входных данных

Вы получаете базу данных **SQLite**, которая состоит из четырех таблиц:

1. **Users** — клиенты.
2. **Templates** — доступные уровни лояльности.
3. **Products** — товары, которые приобретает клиент.
4. **Operations** — операции всех клиентов.

---

### Уровни лояльности

У клиента может быть один из трех уровней лояльности:

- **Bronze** — только кэшбек.
- **Silver** — скидка и кэшбек.
- **Gold** — только скидка.

---

### Модификаторы товаров

Товары могут иметь один из следующих модификаторов (таблица `Products`):

- **discount** — дополнительная скидка, распространяется на все уровни лояльности.
- **increased_cashback** — дополнительный кэшбек, распространяется на все уровни лояльности.
- **noloyalty** — товар **не участвует** в программе лояльности (на такие товары не начисляются скидки/баллы, и списывать баллы с них нельзя).

---

### Дополнительные условия

- Пользователь может списывать **100% чека бонусными баллами.**
    - Исключение: товары с модификатором **noloyalty**.
- Для реализации необходимо:
    - Использовать **Ruby + Sinatra**.
    - Работать с подготовленной базой данных **SQLite3**.
    - Взаимодействовать с базой данных через гем **Sequel**.

> **Примечание:** Ограничения по времени и памяти выполнения кода отсутствуют, но приветствуется **максимально лаконичная и понятная реализация**.

---

## II. Запросы

Необходимо реализовать два эндпоинта:

### 1. Расчет скидок и бонусов за операцию

На вход поступает запрос с данными:

- **user_id** — ID пользователя, совершающего покупку.
- **positions** — массив товаров. Каждый элемент содержит:
    - **id** — ID товара.
    - **price** — цена одной единицы товара.
    - **quantity** — количество товара.

#### Ответ:
Эндпоинт возвращает следующую информацию:

- **статус** операции.
- **информация о пользователе**.
- **id операции**.
- **сумма** (с учетом скидок).
- **данные о бонусах**:
    - текущий баланс бонусов пользователя;
    - доступная сумма для списания;
    - общий процент кэшбека;
    - бонусные баллы, которые будут начислены за покупку.
- **данные о скидках**:
    - общая сумма скидки;
    - общий процент скидки.
- **массив позиций**, где каждая позиция включает:
    - **тип** (например, скидка или кэшбек);
    - **значение**;
    - **описание**;
    - **процент скидки**;
    - **значение скидки**.

---

### 2. Подтверждение операции

На вход поступает запрос с данными:

- **user** — информация о пользователе.
- **operation_id** — ID операции.
- **write_off** — количество бонусов, которые пользователь хочет списать.

#### Ответ:
Эндпоинт возвращает следующую информацию:

- **статус** операции.
- **системное сообщение** (сервисное уведомление).
- **данные об операции**:
    - ID пользователя.
    - количество бонусов, заработанных за операцию (кэшбек);
    - общий процент кэшбека;
    - общая скидка;
    - общий процент скидки;
    - количество списанных баллов;
    - итоговую сумму к оплате.

---

## III. Исходные материалы

Вместе с тестовым заданием предоставляются:

- База данных **SQLite3**, содержащая таблицы `Users`, `Templates`, `Products`, `Operations`.
- **Postman-коллекция** для примера работы запросов.

> Эти ресурсы будут доступны по предоставленной вам ссылке.

---
